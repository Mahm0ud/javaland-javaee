# Jakarta EE on Microsoft Azure with Cargo Tracker

## WebLogic Server on AKS

### Prepare to deploy a WLS cluster with Azure App Gateway with the Portal

<details>
  <summary>
    <b>20min</b> <b>Self-guided</b>. Use the Portal to prepare to deploy cargotracker inside of WLS on AKS.
  </summary>
  
1. Visit the Portal [https://aka.ms/publicportal](https://aka.ms/publicportal).

1. In the search box, without pressing enter, type "weblogic" without the quotes.

1. In the section of suggested results labeled **Marketplace**, select **Oracle WebLogic Server on Azure Kubrenets Service**.

1. Select **Create**.

{% include new-resource-group.md %}

1. In **Region** enter `{{ site.data.var.region }}`.

1. Leave **Username for WebLogic Administrator** with the default value.

1. For **Password for WebLogic Administrator** and following password fields use `{{ site.data.var.workshopPassword }}`.

{% include add-uami.md %}

1. On **Optional Basic Configuration** select **No** and examine the options.  Note you can specify Java JVM options here.

1. Select **Yes** to close the **Optional Basic Configuration**.

1. Scroll down and note the hyperlinks in the **Report issues, get
   help, and share feedback** section.  The links will open in a new
   tab.  We especially encourage you to take the survey about Java EE
   usage.  this will help us create better Java EE on Azure offers.
   
1. Select **Next: Configure AKS cluster**.

1. Explore the options available, but do not select any of the following.
   
   1. [Azure Container Insights integration](https://aka.ms/wls-aks-container-insights)
   
   1. [Persist Volume integration]({{ site.data.var.docsMicrosoftCom }}/azure/aks/concepts-storage)

1. In **Image selection** leave the values at the defaults.

1. In **Username for Oracle Single Sign-On authentication** and the
   corresponding password field, use the values provided by the
   instructor in the Etherpad.
   
1. In **Is the specified SSO account associated with an active Oracle
   support contract?**, select **No**.
   
      **IMPORTANT** This offer really should only be used with an
      active Oracle support contract.  Without a support contract, you
      are running software that has not been patched against the
      latest security vulnerabilities, including the infamous
      Log4shell.  For complete details see the [Oracle documentation](https://aka.ms/wls-aks-ocr-doc).
      
      Thankfully, for this workshop, we are also deploying Azure App
      Gateway, and the offer sets up OWASP rules to protect against
      some of the vulnerabilities.
      
1. In the **Select desired combination of WebLogic...** drop down,
   leave the default, but explore the other available options.
   
1. In the **Java EE Application** section, ensure **Yes** is selected.

1. Select the **Browse** button.

1. In the **Storage accounts** browser, select the storage account
   created by the workflow you ran previously. It will be something
   like `wlsdsa19251229631`.
   
1. In the **Containers** section, select the storage container
   created by the workflow you ran previously. It will be something
   like `wlsdcon19251229631`.
   
1. In the **Container**, select **cargo-tracker.war**.  This also was
   generated by the workflow you ran previously.
   
1. Select **Select**.

1. Leave the remaining values at their defaults.

1. Select **Next: TLS/SSL configuration**.

1. This tab lets you configure end-to-end TLS connections.  Explore the values, but leave it set at **No**.

1. Select **Next: Networking**.

1. Leave **Standard Load Balancer service** at **No**, but feel free
   to explore the documentation link.
   
1. In **Application Gateway Ingress Controller** select **Yes**.

1. The offer provides several ways to upload the certificates
   necessary to enable App Gateway integration.  Select **Generate a
   self-signed front-end certificate**.
   
1. For **Service Principal** refer to the output from the `setup.sh`
   script you ran at the beginning of the workshop.  Find the value
   for `SERVICE_PRINCIPAL`.  Copy it to the clipboard.  Be extremely
   careful to get the whole value.
   
1. To verify you have it all, you can enter the following command in
   the Cloud Shell.
   
      `echo <paste> | base64 -d` and press enter.
      
      If you see valid JSON, you have captured the entire base64
      string to the clipboard.  Save the decoded value in your text
      file, in case you need it later.
   
1. Paste this value into the **Service Principal** and **Confirm password** fields.

1. Ensure **Enable cookie based affinity** is checked.

1. Leave the remaining values at their defaults.

1. Select **Next: DNS configuration**.

1. This tab lets you connect a DNS zone to your WLS on AKS.  Explore
   the values, but leave it set at **No**.
   
1. Select **Next: Database**.

1. For **Connect to database?** select **Yes**.

1. For the **Choose database type** select **Azure Database for PostgreSQL**.

1. For **JNDI name** enter `jdbc/CargoTrackerDB`.

1. For **Datasource Connection String** enter `jdbc:postgresql://<dbName>.postgres.database.azure.com:5432/postgres`, where `<dbName>` is the value you captured above for database name.  This will be something like `wlsdb19251229631`.

1. For **Global transactions protocol** Select **EmulateTwoPhaseCommit**.

1. For **Database username** enter `weblogic`.  This value was set as a secret in `setup.sh`.

1. For **Database Password** enter `Secret123!`.  This value was set as a secret in `setup.sh`.  Make sure to get the exclamation point.

1. Select **Next: Review + create**.

1. **DO NOT Select Create**. At this point, we will use a GitHub
Actions workflow to do the same thing that would happen if you
deployed the offer as you have configured it here.


</details>

### Perform the deployment with GitHub Actions Infrastructure as Code

<details>
  <summary>
    <b>60min</b> <b>Self-guided</b>. Deploy the app and infrastructure using GitHub Actions.
  </summary>

1. Visit your fork of [https://github.com/{{ site.data.var.repoOwner }}/{{ site.data.var.repoPath }}](https://github.com/{{ site.data.var.repoOwner }}/{{ site.data.var.repoPath }}).

1. Select **Actions**.

1. Select **Setup WLS on AKS**.

1. Select **Run workflow**.

1. <a name="wls-aks-pipeline-values">Use the the same values</a> you [captured previously](#liberty-aks-pipeline-values).
   
1. Select **Run workflow**.

1.  Instructor will walk you through
    `.github/workflows/setupWlsAks.yml`, which you have in your
    repo.  Briefly, this workflow uses the repository secrets you
    created earlier to do the following.
    
      1. Use the 
         [Bicep]({{ site.data.var.docsMicrosoftCom }}/azure/azure-resource-manager/bicep/overview?tabs=Bicep)
         infrastructure as code that stands behind the Portal offer from the preceding section to build an ARM template.
         
      1. Build up parameters that happen to represent the values you
         previously filled out in the Portal.
      
      1. Build cargotracker and upload it to storage. Strictly
         speaking, this step is not necessary since the storage
         account already has the cargotracker war.
         
      1. Deploy the offer.  This eventually invokes the [Azure support
         in WebLogic Kubernetes Operator](https://aka.ms/wls-aks-docs).

</details>

### After deployment completes

<details>
  <summary>
    <b>15Min</b> <b>Self-guided</b>. Take a tour of the deployment.
  </summary>
  
**Note** The resource group name will be prefixed by **wlsd-aks**.
  
{% include find-resource-groups.md %}

{% include find-outputs.md %}

1. **Self-guided**. Examine the outputs.

   1. Execute **shellCmdtoConnectAks** to connect to the cluster in the Cloud Shell.
   
   1. Take note of the name of the value of the `--resource-group`
      option to the command.  You will need this later.  This really
      should be in the outputs.  [You are welcome to fix
      this](https://github.com/oracle/weblogic-azure/issues/123).
      
   1. Execute **shellCmdtoOutputWlsDomainYaml** to output a YAML
      description of the WebLogic domain to the file `domain.yml`.
      
      Examine the `domain.yml` file with help from the [Oracle
      documentation](https://oracle.github.io/weblogic-kubernetes-operator/userguide/managing-domains/domain-resource/#domain-spec-elements).
      This is actually a Kubernetes Custom Resource Definition (CRD).
      The complete reference of this CRD is generated live by Oracle.
      See the [reference documentation for complete
      details](https://github.com/oracle/weblogic-kubernetes-operator/blob/main/documentation/domains/Domain.md).
      For complete documentation about CRD, see the [Kubernetes
      site](https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/).
      
   1. Execute **shellCmdtoOutputWlsVersionsandPatches** to output a text description of the runtime to a file `version.info`.

   {{ site.data.var.servletBoast }}

   1. Obtain the URL of the cargotracker by looking at the value of
      the output **clusterExternalUrl**.
      
#### Exercise the Cargo Tracker app

The Cargo Tracker main URL is the **clusterExternalUrl** obtained in
the preceding step, followed by `/cargo-tracker/`.

{% include exercise-cargotracker.md %}


</details>

### Update the deployment with GitHub Actions Infrastructure as Code

<details>
  <summary>
    <b>15min</b> Update the CargoTracker app with a workflow.
  </summary>
  
1. Visit the Cargo Tracker main URL.

1. Take note of the version number at the bottom of the page.  It
   should be something like **2.1-SNAPSHOT 2022-03-02 23:08:32**.

1. Visit your fork of [https://github.com/{{ site.data.var.repoOwner }}/{{ site.data.var.repoPath }}](https://github.com/{{ site.data.var.repoOwner }}/{{ site.data.var.repoPath }}).

1. Select **Actions**.

1. Select **Update Cargo Tracker to WLS on AKS**.

1. Select **Run workflow**.

1. Use the correct **region**.

1. Leave **weblogic image path** at the default value.

1. For **Specify resource group of aks cluster** use the value you
   captured in the preceding step.
   
1. For storage account and container, use the values [gathered
   above](#wls-aks-pipeline-values).
   
1. For the ACR related parameters, use the following steps to get them
   directly from the deployed ACR.
   
   1. In a new portal tab, find the resource group containing the AKS cluster.
   
   1. In the navigation pane for the resource group, select
      **Overview**.
      
   1. In the **Settings** section, select **Access keys**.
   
   1. Save aside the **Login server**. This value is the **Specify ACR
      server of uploading image** in the workflow.
      
   1. Save aside the **Registry name**. This value is the **Specify
      ACR server user name** in the workflow.
      
   1. Save aside the **Password**.  This value is the
      **AZURE_ACR_PASSWORD** GitHub Actions repository secret.
      
   1. In the Cloud Shell, type `gh --repo <your github name>/{{ site.data.var.repoPath }} secret set
      AZURE_ACR_PASSWORD -b` and paste the saved value.
      **Ensure there is no space after `-b`**.  Press enter.
      
      * You should see **✓ Set secret AZURE_ACR_PASSWORD for your github name/{{ site.data.var.repoPath }}**.

   1. Leave the remaining values at their defaults.
   
   1. Select **Run workflow**.

</details>

### Remove deployment

<details>
  <summary>
    <b>5min</b> Remove resources to save your subscription cost.
  </summary>

You must remove the deployment to avoid consuming more Azure resources
than your pass allows.

1. In Cloud Shell, enter `az aks delete --no-wait --name <your cluster name> --resource-group <your resource group>`.

1. In the Portal, find `<your resource group>` and select **Delete resource group**.

1. Copy past the name of the resource group and select **Delete**.

</details>



[home](../)
